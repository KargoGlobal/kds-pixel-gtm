___INFO___

{
  "displayName": "Kargo Measurement Pixel",
  "description": "Kargo Measurement Pixel for Editorial and Behavioral Insights for Media Recommendations",
  "securityGroups": [],
  "id": "cvt_temp_public_id",
  "type": "TAG",
  "version": 1,
  "brand": {
    "thumbnail": "data:image/png;base64,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",
    "displayName": "",
    "id": "brand_dummy"
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "notSetText": "Please enter partner ID provided by Kargo",
    "help": "Please reach out to Kargo to learn more.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "displayName": "Partner ID",
    "simpleValueType": true,
    "name": "partnerId",
    "type": "TEXT"
  },
  {
    "help": "Please insert a value if tracking a non-pageview event",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "displayName": "Event Name",
    "defaultValue": "PageView",
    "simpleValueType": true,
    "name": "eventName",
    "type": "TEXT"
  }
]


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "kds"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "kds.relayCallMethod"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://storage.cloud.kargo.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Require APIs
const callInWindow = require('callInWindow');
const copyFromWindow = require('copyFromWindow');
const injectScript = require('injectScript');
const log = require('logToConsole');
const setInWindow = require('setInWindow');

const pId = data.partnerId;
const eventName = data.eventName;

const evtJsUrl = 'https://storage.cloud.kargo.com/kds/kds-events-gtm.min.js';
let extKds = copyFromWindow('kds') || {};

// Skip kds initialization if it's already loaded
if (extKds.version) {
  callInWindow('kds', 'init', pId);
  callInWindow('kds', 'track', eventName);
  return;
}

let kds = function () {
  // If needed, check for external script readiness
  if (kds.isInitialized && !kds.isReady) {
    extKds = copyFromWindow('kds');
    if (extKds && extKds.callMethod) {
      kds.isReady = true;
    }
  }

  if (extKds.callMethod) {
    // Relay calls to external kds
    callInWindow('kds.relayCallMethod', arguments);
  } else {
    // Queue events when external script isn't loaded
    kds.queue.push(arguments);
  }
};

// Define kds properties
kds.version = '1.0';
kds.isInitialized = false;
kds.isReady = false;
kds.queue = [];

// Queue the initial events
kds('init', pId);
kds('track', eventName);
kds.isInitialized = true;

// Make kds visible outside
const overrideExisting = false;
setInWindow('kds', kds, overrideExisting);

// Inject external JS
injectScript(evtJsUrl, data.gtmOnSuccess, data.gtmOnFailure, evtJsUrl);


___NOTES___

Created on 8/6/2019, 10:00:11 AM
